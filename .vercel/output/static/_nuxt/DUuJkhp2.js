import{_ as J}from"./VnKSk5Dv.js";import{_ as L,a as k}from"./8hJOxu5z.js";import{_ as z}from"./BRKyBaGh.js";import{h as H,n as m,m as K,r as x,l as Q,x as D,y as W,w as u,z as X,j as o,o as S,b as s,a as _,c as Z,s as ee,t as te,g as ae,d as C,f as ne,p as oe,A as se}from"./DNOTuklV.js";import{_ as le}from"./BkXjYmYK.js";import{_ as re}from"./BjgpcN_8.js";import{u as ue}from"./bwWeQDxp.js";import{o as de,s as p,b as ie}from"./NeIn7EVK.js";const me={class:"space-y-4"},pe={class:"grid grid-cols-2 gap-4"},ce={class:"ml-3 text-sm text-gray-600 dark:text-gray-400"},_e={key:0,class:"grid grid-cols-2 gap-4"},fe={class:"flex justify-end space-x-3 mt-6"},xe=H({__name:"InvoiceGeneratorModal",props:{modelValue:{type:Boolean},preselectedPartnerId:{}},emits:["update:modelValue"],setup(h,{emit:w}){const g=h,F=w,c=m({get:()=>g.modelValue,set:t=>F("update:modelValue",t)}),A=de({partnerId:p().min(1,"Partner is required"),unitId:p().optional(),year:p().min(1,"Year is required"),month:p().min(1,"Month is required"),useCustomDates:ie(),startDate:p().optional(),endDate:p().optional()}).refine(t=>t.useCustomDates?t.startDate&&t.endDate&&new Date(t.startDate)<=new Date(t.endDate):!0,{message:"End date must be after start date when using custom dates",path:["endDate"]}),b=new Date,N=b.getFullYear().toString(),M=(b.getMonth()+1).toString(),a=K({partnerId:"",unitId:"",year:N,month:M,useCustomDates:!1,startDate:"",endDate:""}),v=x(!1),{partners:V,units:I,loadPartners:$,loadUnits:B,isLoading:U}=Q(),{generateInvoice:P}=oe();x([]);const y=m(()=>U.partners||U.units),q=m(()=>Array.isArray(V.value)?V.value.map(t=>({label:t.name,value:t.id})):[]),T=m(()=>!a.partnerId||!Array.isArray(I.value)?[]:I.value.filter(t=>t&&t.partner_id===a.partnerId).map(t=>({label:t.name,value:t.id}))),Y=m(()=>{const t=[],e=new Date().getFullYear();for(let l=e-5;l<=e+2;l++)t.push({label:l.toString(),value:l.toString()});return t.reverse()}),j=m(()=>[{label:"January",value:"1"},{label:"February",value:"2"},{label:"March",value:"3"},{label:"April",value:"4"},{label:"May",value:"5"},{label:"June",value:"6"},{label:"July",value:"7"},{label:"August",value:"8"},{label:"September",value:"9"},{label:"October",value:"10"},{label:"November",value:"11"},{label:"December",value:"12"}]);D(()=>a.partnerId,()=>{a.unitId=""}),D(()=>g.modelValue,async t=>{t&&await Promise.all([$(),B()])},{immediate:!0}),D(()=>g.preselectedPartnerId,t=>{t&&(a.partnerId=t)},{immediate:!0});const E=async()=>{try{v.value=!0;let t,e;if(a.useCustomDates)t=a.startDate,e=a.endDate;else{const n=parseInt(a.year),i=parseInt(a.month);t=`${n}-${i.toString().padStart(2,"0")}-01`;const f=new Date(n,i,0).getDate();e=`${n}-${i.toString().padStart(2,"0")}-${f.toString().padStart(2,"0")}`}const l=await P(a.partnerId,t,e),d={partnerName:l.partner_name,period:l.period,sharePercentage:l.share_percentage,bookings:l.bookings.map(n=>({date:n.date,endDate:n.end_date,guestName:n.guest_name,unitName:n.unit_name,source:n.booking_source_name,baseAmount:parseFloat(n.base_amount),addons:parseFloat(n.addons_total),total:parseFloat(n.total_amount),paymentReceivedBy:n.payment_received_by,actualAmountReceived:parseFloat(n.total_amount),bookingStatus:n.booking_status})),expenses:l.expenses.map(n=>({date:n.date,unitName:n.unit_name,type:n.type,notes:n.notes,amount:parseFloat(n.amount)})),journalEntries:l.journal_entries.map(n=>({date:n.date,type:n.type,description:n.description,reference:n.reference,amount:parseFloat(n.amount)}))};await se(`/invoices/${l.id}`),c.value=!1}catch{const{notifyError:e}=ue();e("Failed to generate invoice")}finally{v.value=!1}};return(t,e)=>{const l=J,d=L,n=z,i=k,f=ae,G=le,O=ne,R=re;return S(),W(R,{modelValue:o(c),"onUpdate:modelValue":e[8]||(e[8]=r=>X(c)?c.value=r:null)},{default:u(()=>[s(O,null,{header:u(()=>e[9]||(e[9]=[_("h3",{class:"text-lg font-semibold"},"Generate Invoice",-1)])),default:u(()=>[s(G,{schema:o(A),state:o(a),onSubmit:E},{default:u(()=>[_("div",me,[s(d,{label:"Partner",name:"partnerId",required:""},{default:u(()=>[s(l,{modelValue:o(a).partnerId,"onUpdate:modelValue":e[0]||(e[0]=r=>o(a).partnerId=r),options:o(q),loading:o(y),placeholder:"Select partner"},null,8,["modelValue","options","loading"])]),_:1}),s(d,{label:"Unit",name:"unitId"},{default:u(()=>[s(l,{modelValue:o(a).unitId,"onUpdate:modelValue":e[1]||(e[1]=r=>o(a).unitId=r),options:o(T),disabled:!o(a).partnerId||o(y),loading:o(y),placeholder:"All units (optional)"},null,8,["modelValue","options","disabled","loading"])]),_:1}),_("div",pe,[s(d,{label:"Year",name:"year",required:""},{default:u(()=>[s(l,{modelValue:o(a).year,"onUpdate:modelValue":e[2]||(e[2]=r=>o(a).year=r),options:o(Y)},null,8,["modelValue","options"])]),_:1}),s(d,{label:"Month",name:"month",required:""},{default:u(()=>[s(l,{modelValue:o(a).month,"onUpdate:modelValue":e[3]||(e[3]=r=>o(a).month=r),options:o(j)},null,8,["modelValue","options"])]),_:1})]),s(d,{label:"Custom Date Range",name:"useCustomDates"},{default:u(()=>[s(n,{modelValue:o(a).useCustomDates,"onUpdate:modelValue":e[4]||(e[4]=r=>o(a).useCustomDates=r)},null,8,["modelValue"]),_("span",ce,te(o(a).useCustomDates?"Using custom date range":"Using month/year selection"),1)]),_:1}),o(a).useCustomDates?(S(),Z("div",_e,[s(d,{label:"Start Date",name:"startDate"},{default:u(()=>[s(i,{modelValue:o(a).startDate,"onUpdate:modelValue":e[5]||(e[5]=r=>o(a).startDate=r),type:"date"},null,8,["modelValue"])]),_:1}),s(d,{label:"End Date",name:"endDate"},{default:u(()=>[s(i,{modelValue:o(a).endDate,"onUpdate:modelValue":e[6]||(e[6]=r=>o(a).endDate=r),type:"date"},null,8,["modelValue"])]),_:1})])):ee("",!0)]),_("div",fe,[s(f,{color:"gray",variant:"ghost",onClick:e[7]||(e[7]=r=>c.value=!1)},{default:u(()=>e[10]||(e[10]=[C("Cancel",-1)])),_:1,__:[10]}),s(f,{type:"submit",color:"primary",loading:o(v)},{default:u(()=>e[11]||(e[11]=[C(" Generate Invoice ",-1)])),_:1,__:[11]},8,["loading"])])]),_:1},8,["schema","state"])]),_:1})]),_:1},8,["modelValue"])}}});export{xe as _};
